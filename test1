# dataset: Movielens
# method：matrix decomposition
# language:python

import pandas as pd
import numpy as np
from keras import Model
import keras.backend as K
from keras.layers import Embedding, Reshape, Input, Dot


# 获得用户数和电影数
rating = pd.read_csv("C:/Users/L/Desktop/ratings.csv",sep=",")
num_user = np.max(rating["userId"])
num_movie = np.max(rating["movieId"])

# 对电影Id进行处理，添加一列索引
movies_df = pd.read_csv('C:/Users/L/Desktop/movies.csv')
# movies_df['movieRow'] = movies_df.index
print(num_user,num_movie,len(rating))
# print(rating["userId"].values)
# print(rating["movieId"].values)


train_user = rating["userId"].values
train_movie = rating["movieId"].values
train_x = [train_user,train_movie]
train_y = rating["rating"].values

array = np.zeros((num_user+1,num_movie+1))
print(array.shape)

for index,row in rating.iterrows():
    s = index
    int1 = int(row['userId'])
    int2 = int(row['movieId'])
    array[int1,int2] = row['rating']

print(array)
record = np.array(array>0,dtype=int)
print(record)

K.clear_session()


def Recmand_model(num_user, num_movie, k):
    input_uer = Input(shape=[None, ], dtype="int32")
    model_uer = Embedding(num_user + 1, k, input_length=1)(input_uer)
    model_uer = Reshape((k,))(model_uer)

    input_movie = Input(shape=[None, ], dtype="int32")
    model_movie = Embedding(num_movie + 1, k, input_length=1)(input_movie)
    model_movie = Reshape((k,))(model_movie)

    # 矩阵分解
    out = Dot(1)([model_uer, model_movie])
    model = Model(inputs=[input_uer, input_movie], outputs=out)
    model.compile(loss='mse', optimizer='Adam',metrics=['accuracy'])
    model.summary()
    return model


model = Recmand_model(num_user,num_movie,100)



model.fit(train_x,train_y,batch_size = 150,epochs =1)

# result = model.predict(record)

a = input("请输入用户名：")
user = int(a)
result = np.array([])

for i in range(num_movie):
    temp = model.predict([[user],[i]])
    result = np.append(result,temp)

print(user)
print(result)

for i in range(num_movie):
    if record[user][i] == 1 :
        result[i] = 0
recommend = np.argsort(result)

a = recommend[-1]
b = recommend[-2]
c = recommend[-3]
d = recommend[-4]
e = recommend[-5]
print('为用户%d推荐的电影为：\n1:%s\n2:%s\n3:%s\n4:%s\n5:%s。' \
      % (user,movies_df['title'][a], movies_df['title'][b], movies_df['title'][c], movies_df['title'][d],movies_df['title'][e]))
